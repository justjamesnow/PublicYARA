rule apt_patchwork_badnews : APT Windows Patchwork {
	meta:
		author = "James E.C, Emerging Threats - Proofpoint"
		twitter = "@EcOzurie"
		mastodon = "https://infosec.exchange/@ozurie"
		description = "BADNEWS backdoor by Patchwork group"
		hashes = "ab4f86a3144642346a3a40e500ace71badc06a962758522ca13801b40e9e7f4a"
		reference = "https://researchcenter.paloaltonetworks.com/2018/03/unit42-patchwork-continues-deliver-badnews-indian-subcontinent/"
		date = "15-03-2018"
		id = "10011"
	strings:
		// $regex1 = /[a-z]{3}[0-9]{3}\.dat/
		// $regex2 = /[A-Z]{3}[0-9]{3}\.dat/

		$x1 = "nealfrancisw@protonmail.com" ascii fullword
		$x2 = "TPX499.dat" ascii fullword
		$x3 = "edg499.dat" ascii fullword
		$x4 = "adbFle.tmp" ascii fullword
		$x5 = "iuuq;" ascii

		$enc1 = "iuuqt;00sbx/hjuivcvtfsdpoufou/dpn0ivtohjmhju0ivtobib{su0nbtufs0ynm/ynm" // iuuqt; = https:
		$enc2 = "iuuq;00xxx/xfcstt/dpn0dsfbufgffe/qiq@gffeje>5::77"
		$enc3 = "iuuq;00gffe54/dpn09277817839963961/ynm"

		$partial_decode_C2 = { 88 04 0F 8A 41 ?? 41 0F BE D8 42 3B D3 8B 1D C0 71 41 00 7C ?? }

		$uri1 = "#un=" ascii fullword
		$uri2 = "lan=" ascii fullword
		$uri3 = "nop=" ascii fullword
		$uri4 = "ver=" ascii fullword
		$uri5 = "uuid=" ascii fullword

		$s1 = "&crc=e3a6" ascii
		$s2 = "&r=1" ascii
		$s3 = "http://%[^/]" ascii
		$s4 = "cmd.exe" ascii fullword
		$s5 = "POST" ascii fullword
    
	condition:
		uint16be(0) == 0x4d5a and filesize < 400KB and $partial_decode_C2 or (
		2 of ($x*) or 3 of ($uri*) and 2 of ($s*) or 1 of ($enc*) and 2 of ($s*)
		)
}
