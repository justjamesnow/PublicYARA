rule win32_phorpiex_love : Windows Spambot Phorpiex {
	meta:
		author = "James E.C, Emerging Threats - Proofpoint"
		twitter = "@EcOzurie"
		mastodon = "https://infosec.exchange/@ozurie"
		description = "Detect active Phorpiex spam module seen in Nov 2018 (GandCrab via js zip)"
		hash = "53502c8abe4a2a902140d283a85e4e2b"
		date = "23-11-2018"
		updated = "NA"
		category = "malware"
		malfamily = "Phorpiex"
	strings:
		$x1 = "aol.com" ascii fullword
		$x2 = "Gina" ascii fullword
		$x3 = "%snumber.txt" ascii fullword
		$x4 = "%s.js" ascii fullword
		$x5 = "%sloader.js" ascii fullword
		$x6 = "%ls\\%d%d.jpg" wide
		$x7 = "%ls\\%d%d.zip" wide
		$x8 = "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.9; rv:25.0) Gecko/20100101 Firefox/25.0"

		$spam1 = "I love you" ascii fullword
		$spam2 = "My letter just for you" ascii fullword
		$spam3 = "Please read and reply" ascii fullword
		$spam4 = "Wrote this letter for you" ascii fullword
		$spam5 = "Just for you" ascii fullword
		$spam6 = "This is my love letter to you" ascii fullword
		$spam7 = "My love letter for you" ascii fullword
		$spam8 = "Wrote my thoughts down about you" ascii fullword
		$spam9 = "Wrote the fantasy about us down" ascii fullword
		$spam10 = "Felt in love with you!" ascii fullword
		$spam11 = "Always thinking about you" ascii fullword
		$spam12 = "You are my love!"

		$fname = "Love_You_2018_%d" ascii fullword

		//$dir = /C:\\Windows\\\d{5,20}\\[A-Za-z0-9]+\.exe/

		$cnc1 = "http://92.63.197.48/m/" ascii fullword
		$cnc2 = "http://tdtudufzd.ru/m/" ascii fullword

		$opc_1 = { E8 BE 2D 00 00 99 B9 ?? 00 00 00 F7 F9 83 C2 ?? 8B ?? ?? 03 ?? ?? 88 10 }
	condition:
		(uint16be(0) == 0x4d5a and filesize < 500KB) and ((5 of ($x*) and 1 of ($spam*)) or (1 of ($spam*) and $fname) or (1 of ($spam*) and $opc_1) or (1 of ($cnc*)))
}

rule win32_phorpiex_original : Spambot Windows Trik Phorpiex {
	meta:
		author = "James E.C, Emerging Threats - Proofpoint"
		twitter = "@EcOzurie"
		mastodon = "https://infosec.exchange/@ozurie"
		description = "Detect email lure template or spambot used by Trik/Phorpiex botnet, seen distributing Gandcrab in April 2018"
		hashes = "ca01b467de0277cf2bb1d58430a550c84aa47b49752dff2c9d18d8bcf4254676"
		date = "09-04-2018"
		updated = "20-06-2018"
		category = "malware"
		malfamily = "Phorpiex"
	strings:
		$eml1 = "Dear Customer,"
		$eml2 = "to read your document please open the attachment and reply as soon as possible."
		$eml3 = "Kind regards,"
		$eml4 = " Customer Support"
		$eml5 = /DOC\d{10}-\w{3}\.zip/

		$subject1 = "Document #"
		$subject2 = "Your Document #"
		$subject3 = "Invoice #"
		$subject4 = "Payment Invoice #"
		$subject5 = "Order #"
		$subject6 = "Your Order #"
		$subject7 = "Payment #"
		$subject8 = "Ticket #"
		$subject9 = "Your Ticket #"

		$bot1 = "smtp://%s|%s:%d|%s|%s"
		$bot2 = "smtp://%s@%s|%s:%d|%s|%s"
		$bot3 = "ftp://%s:%s@%s"
		$bot4 = "Received: from %s ([%d.%d.%d.%d]) by %s with MailEnable ESMTP; %s"
		$bot5 = "DOC%d%d-PDF"
		$bot6 = /%ls\\\w-\d{15,40}/ wide // Bot filename on harddisk
		$bot7 = "SYSTEM\\CurrentControlSet\\Services\\SharedAccess\\Parameters\\FirewallPolicy\\StandardProfile\\AuthorizedApplications\\List\\" wide
		$bot8 = "DisableAntiSpyware" wide
		$bot9 = "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.9; rv:25.0) Gecko/20100101 Firefox/25.0"
		$bot10 = "NICK" ascii fullword
		$bot11 = "JOIN" ascii fullword
		$bot12 = "PRIVMSG" ascii fullword
		$bot13 = "%ls%d%d%d%d%d%d%d%d%d%d.exe" wide
		$bot14 = "http://api.wipmania.com/" ascii
		$bot15 = "%s%s.zip" ascii
		$bot16 = "%s.js" ascii

		$rc4_key_ops = { D1 E9 81 F1 20 83 B8 ED }

	condition:
		//detect email
		//(all of ($eml*) and 1 of ($subject*)) or 
		//detect bot executables
		uint16(0) == 0x5a4d and filesize < 200KB and (1 of ($eml*) and 5 of ($subject*) and (4 of ($bot*) or $rc4_key_ops)) 
		or
		uint16(0) == 0x5a4d and filesize < 200KB and (10 of ($bot*))
}

rule win32_phorpiex_stealerVariant : Spambot Windows Trik Phorpiex {
	meta:
		author = "James E.C, Emerging Threats - Proofpoint"
		twitter = "@EcOzurie"
		mastodon = "https://infosec.exchange/@ozurie"
		description = "Detecting updated Phorpiex bot after the June 21st update (new email subjects)"
		hashes = "b6a63c04530d3160d9994c5a264db3cebd5a39db44ce10760e9f12b65591531d"
		date = "22-06-2018"
		category = "malware"
		malfamily = "Phorpiex"
	strings:
		$bot1 = "%lsgo.js" wide fullword
		$bot2 = "%ls\\%d%d%d.zip" wide fullword
		$bot3 = "%ls\\%d%d%d.jpg" wide fullword
		$bot4 = "%ls%d.txt" wide fullword
		$bot5 = "windrv.exe" wide fullword
		$bot6 = /%ls\\\w-\d{15,40}/ wide
		$bot7 = "SYSTEM\\CurrentControlSet\\Services\\SharedAccess\\Parameters\\FirewallPolicy\\StandardProfile\\AuthorizedApplications\\List\\" wide
		$bot8 = "SOFTWARE\\Policies\\Microsoft\\Windows Defender\\" wide
		$bot9 = "DisableAntiSpyware" wide
		$bot10 = "@-:=*{{TMLR}}*=:-" ascii fullword
		$bot11 = "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.9; rv:25.0) Gecko/20100101 Firefox/25.0" ascii fullword
		$bot12 = "2018%s_%s.jpg"

		$spam1 = "Take a look at my new picture please" ascii fullword
		$spam2 = "What you think about her new picture?" ascii fullword
		$spam3 = "I'm about to post this on facebook" ascii fullword
		$spam4 = "You will be shoked!" ascii fullword
		$spam5 = "Trumps private photo leaked!" ascii fullword
		$spam6 = "Lol.. look at her new photo!" ascii fullword
		$spam7 = "Someone takes photos from you" ascii fullword

		$wallet1 = "1DYwJZfyGy5DXaqXpgzuj8shRefxQ7jCEw" ascii fullword
		$wallet2 = "BCedWttszcCs9uThQJBdJeEvi83vQgxrAa" ascii fullword
		$wallet3 = "228Urw5BHKCiikBcGe37AYVNjJKA6xb4L9RepZ76KasQSSTg1DeertgFr6MNqj3PGR4PGXzCGYQw7UemxRoRxCC97qdga22" ascii fullword
		$wallet4 = "XxZ274qGCfFyEi2HRS5G1215vEX331Mhc1" ascii fullword
		$wallet5 = "D78VANgC5hQ3n4BSnon6aq6qnQSViyAmLv" ascii fullword
		$wallet6 = "EZyjJj7M9gP6bnhw3q5N1gAMyQSVXNh533" ascii fullword
		$wallet7 = "0xff0d45f3e2ec83de3b2e069300974732ba1c5d30" ascii fullword
		$wallet8 = "Lh8F5u2USRj779tQDy6LMYUM6dgPwH3qoP" ascii fullword
		$wallet9 = "4BrL51JCc9NGQ71kWhnYoDRffsDZy7m1HUU7MRU4nUMXAHNFBEJhkTZV9HdaL4gfuNBxLPc3BeMkLGaPbF5vWtANQrhbkDviv3H6fUaKia" ascii fullword
		$wallet10 = "PWGChwvPpdCHyLmURsPgtYCAsqwDAzAsvZ" ascii fullword
		$wallet11 = "AH2GAaJtWdQqsSJCS14tVUTKivzD7B67fP" ascii fullword
		$wallet12 = "RaqJaa3iWaRkHvDkDcnfkhFJjSvzHLjuBk" ascii fullword
		$wallet13 = "rL2zzcnUrDsqPfH6bmbGNG93QYQkDkJ6QV" ascii fullword
		$wallet14 = "t1MH943MSkvEcaXiDQJ4GQk9GPaSTkhDh4r" ascii fullword

		$cnc1 = "http://92.63.197.60/"
		$cnc2 = "http://92.63.197.112/"

		$rc4_key_ops = { D1 E9 81 F1 20 83 B8 ED }

	condition:
		uint16(0) == 0x5a4d and filesize < 200KB and (6 of ($bot*) and 1 of ($spam*)) or (6 of ($bot*) and 2 of ($wallet*)) or (5 of ($bot*) and $rc4_key_ops) or (4 of ($bot*) and 1 of ($cnc*))
}

rule win32_phorpiex_HuntPDB : Spambot Windows Trik Phorpiex PDB_hunting {
	meta:
		author = "James E.C, Emerging Threats - Proofpoint"
		twitter = "@EcOzurie"
		mastodon = "https://infosec.exchange/@ozurie"
		description = "Detecting updated Phorpiex bot after the June 21st update (new email subjects)"
		hashes = "b6a63c04530d3160d9994c5a264db3cebd5a39db44ce10760e9f12b65591531d"
		date = "22-06-2018"
		category = "hunting"
		malfamily = "Phorpiex"
	strings:
		$new_pdb = { 43 3A 5C 55 73 65 72 73 5C 78 5C 44 65 73 6B 74 6F 70 5C 48 6F 6D 65 5C 43 6F 64 65 5C 54 6D 6C 72 20 76 [2-5] 5C 52 65 6C 65 61 73 65 5C 54 6D 6C 72 2E 70 64 62 }

	condition:
		uint16(0) == 0x5a4d and filesize < 200KB and $new_pdb
}
