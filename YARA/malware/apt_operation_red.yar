rule apt_operation_red : Windows dotNET TROJ_BLOODHOUND {
	meta:
		author = "James E.C, Emerging Threats - Proofpoint"
		twitter = "@EcOzurie"
		mastodon = "https://infosec.exchange/@ozurie"
		description = "Operation Red targeting South Korea orgs with info theft."
		reference = "https://blog.trendmicro.com/trendlabs-security-intelligence/supply-chain-attack-operation-red-signature-targets-south-korean-organizations/"
		date = "21-08-2018"
		id = "10009"
	strings:
		$u1 = "BloodHound_{0:yyyyMMddHHmmssfff}.zip" wide fullword
		$u2 = "SharpHound.exe" wide fullword
		$u3 = "<BloodHoundDisplay>k__BackingField" ascii fullword
		$u4 = "{{ AccountName = {0}, DisplayName = {1}, Enabled = {2}, PwdLastSet = {3}, LastLogon = {4}, ObjectSid = {5}, SidHistory = {6}, HasSpn = {7}, Email = {8}, ServicePrincipalNames = {9}, Domain = {10} }}" wide
		$u5 = "Initializing BloodHound at {0} on {1}" wide fullword
		$u6 = "User-Force-Change-Password" wide fullword

		$s1 = "<GetSamAdmins>" ascii
		$s2 = "<CollectStealthTargets>" ascii
		$s3 = "<GetGpoAdmins>" ascii
		$s4 = "<GetEnterpriseDCs>" ascii
		$s5 = "<UserPass>k__BackingField" ascii fullword
		$s6 = "<CurrentUser>k__BackingField" ascii fullword
		$s7 = "ReadPasswordParameters" ascii fullword
		$s8 = "WritePasswordParameters" ascii fullword

		$f1 = "group_membership.csv" wide fullword
		$f2 = "container_structure.csv" wide fullword
		$f3 = "container_gplinks.csv" wide fullword
		$f4 = "user_props.csv" wide fullword
		$f5 = "computer_props.csv" wide fullword
		$f6 = "sessions.csv" wide fullword
		$f7 = "local_admins.csv" wide fullword
		$f8 = "acls.csv" wide fullword
		$f9 = "trusts.csv" wide fullword

		$ops_GetComputerNetbiosName = { 02 1f 64 12 00 28 93 00 00 06 2c 02 }
		$ops_ResolveHost = { 72 57 06 00 70 11 05 11 04 28 54 00 00 0a 12 00 28 5d 00 00 06 2d 06 }

	condition:
		(uint16be(0) == 0x4d5a and filesize < 900KB) and (
		(4 of ($u*) and 5 of ($s*))
		or (2 of ($u*) and 1 of ($ops_*)) 
		or (2 of ($u*) and 4 of ($s*) and 1 of ($f*)
		or (5 of ($s*) and 1 of ($f*) and 1 of ($ops_*)))
		)
}

rule apt_operation_red_sideloadr : Windows dotNET TROJ_ASRALDR_ZKFH {
	meta:
		author = "James E.C, Emerging Threats - Proofpoint"
		twitter = "@EcOzurie"
		mastodon = "https://infosec.exchange/@ozurie"
		description = "Operation Red targeting South Korea orgs with info theft."
		hashes = "2895043B9D230CAE6EE47C7F223A9F46"
		reference = "https://blog.trendmicro.com/trendlabs-security-intelligence/supply-chain-attack-operation-red-signature-targets-south-korean-organizations/"
		date = "21-08-2018"
		id = "10010"
	strings:
		$s1 = "windows\\system32\\regsvr32.exe" ascii fullword
		$s2 = "rcview40u.dll" ascii fullword
		$s3 = "rcview.log" ascii fullword

		$export1 = "CKeybdHook" ascii fullword
		$export2 = "CRCAppCommon" ascii fullword
		$export3 = "CRCAutoScroller" ascii fullword
		$export4 = "CRCFrameImpl" ascii fullword
		$export5 = "CRCSessionInfo" ascii
		$export6 = "CRCWeb" ascii fullword

		$ops_date_check = { 8d 44 24 ?? 50 ff 15 2c b0 00 10 b9 ?? ?? 00 00 66 39 4c 24 ?? 72 } // calls infinite sleep if the year >= 2018 && month >= 8 (Aug)
		$ops_inf_sleep = { 8b 35 04 b0 00 10 68 e8 03 00 00 ff d6 eb } // infinite sleep is called if the execution time is past the killswitch date
		$ops_decrypt = { fe c1 0f b6 f9 8b 4c b8 08 02 d1 89 4d f8 0f b6 ca 8b 55 f8 89 4d fc 8b 4c 88 08 89 4c b8 08 02 ca 0f b6 c9 89 7d f4 8b 7d fc 89 54 b8 08 }

	condition:
		(uint16be(0) == 0x4d5a and filesize < 900KB) and ((1 of ($export*) and 1 of ($ops_*)) or (2 of ($export*) and 1 of ($ops_*)) or (1 of ($s*) and 1 of ($ops_*)))
}
