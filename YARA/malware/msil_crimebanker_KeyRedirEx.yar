rule msil_crimebanker_KeyRedirEx : Windows MSIL Banker {
	meta:
		author = "James E.C, Emerging Threats - Proofpoint"
		twitter = "@EcOzurie"
		mastodon = "https://infosec.exchange/@ozurie"
		description = "MSIL KeyRedirEx Banking Trojan."
		hashes = "d95eaac6b838437ef502ba190da2fa82" // KeyRedirEx
		hashes = "ec33cc6cb625197587410840bce5983b" // BetaBot Dropper
		date = "29-10-2018"
		category = "malware"
		malfamily = "KeyRedirEx"
	strings:
		// $c2_ip possibly irrelevant, legacy rule
		$c2_ip = "159.65.130.246" wide
		$c2_uri = "/red/info.php" wide

		$s1 = "Starting redir timer func" wide fullword // begins main inject loop
		$s2 = "Checking title:" wide fullword // enumerates GetActiveWindowTitle -> array (str cmp later)
		$s3 = "Starting timer2 (requestInfo)" wide fullword // retrieve instruction from C2 (see s7 and s8)
		$s4 = "{F6}" wide fullword // select all in address bar of browser
		$s5 = "{ENTER}" wide fullword // follows ctrl+v, paste phishing address -> enter
		$s6 = "vanderbilt" wide fullword // mutex
		$s7 = "REDIR;" wide fullword // pre-fixes each inject from C2
		$s8 = "EXIT;" wide fullword // malware quit if received from C2
		
	condition:
		(uint16be(0) == 0x4d5a and filesize < 200KB) and 
		((4 of ($s*) or 1 of ($c2_*)))
}
